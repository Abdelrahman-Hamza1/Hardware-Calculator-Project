;====================================================================
; Main.asm file generated by New Project wizard
;
; Created:   Thu Feb 1 2024
; Processor: PIC16F877A
; Compiler:  MPASM (Proteus)
;====================================================================

;====================================================================
; DEFINITIONS
;====================================================================

#include p16f877a.inc                ; Include register definition file

;====================================================================
; VARIABLES
;====================================================================

TimerCounter EQU 0x30
;====================================================================
; RESET and INTERRUPT VECTORS
;====================================================================

      ; Reset Vector
RST   code  0x0 
      goto  Start
     
ISR   code 0x04
      NOP 

      BANKSEL PIR1
      BTFSC PIR1, 0 
      GOTO TimerInterrupt 
   
      BANKSEL PORTD
      DECF PORTD, F
      ;; if not timer interrupt then the interrupt is from the PUSH BUTTON
      BCF INTCON, INTF ; Clear Interrupt Flag
      BCF INTCON, 1 ; Clear the flag interrupt bit
      GOTO endInt
      
TimerInterrupt 
      BANKSEL PIR1
      BCF PIR1, 0 

      INCF TimerCounter, F ; inc and get 
      MOVF TimerCounter, W
     
      XORLW 0x04       
      BTFSS STATUS, Z  
      GOTO endInt
      NOP
      BANKSEL PORTD
      INCF PORTD, F
      CLRF TimerCounter

      
         
endInt
      NOP
      BANKSEL TMR1H
      CLRF TMR1H 
      CLRF TMR1L
      BANKSEL PORTB
      movf PORTB, F	; Read PortB (to itself) to end mismatch condition
      RETFIE     

;====================================================================
; CODE SEGMENT
;====================================================================

PGM   code
Start
      NOP
      ;; Initializations Here!
      BANKSEL TRISD 
      CLRF TRISD 
      
      BANKSEL TRISC 
      CLRF TRISC 
      
      BANKSEL TRISB 
      BSF TRISB, 0
      
      ; Enable Interrupts!
      BSF INTCON, GIE 
      BSF INTCON, PEIE 
      BSF INTCON, INTE
      
      BANKSEL T1CON
      BSF T1CON, T1CKPS1
      BSF T1CON, T1CKPS0  ; 1:8 prescaler
      
      
      BANKSEL PIE1
      BSF PIE1, TMR1IE 
      
      BANKSEL PORTD
      MOVLW 0x00
      MOVWF PORTD
      ; Code Here!
      
      BANKSEL T1CON
      BSF T1CON, TMR1ON ; GET IT COUNTING!
      
      BANKSEL PORTD
Loop
      NOP
      goto Loop
;====================================================================
      END
