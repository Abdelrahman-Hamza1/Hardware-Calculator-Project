;====================================================================
; Main.asm file generated by New Project wizard
;
; Created:   Thu Feb 1 2024
; Processor: PIC16F877A
; Compiler:  MPASM (Proteus)
;====================================================================

;====================================================================
; DEFINITIONS
;====================================================================

#include p16f877a.inc                ; Include register definition file

;====================================================================
; VARIABLES
;====================================================================
TensOne EQU 0X20 
UnitsOne EQU 0X21
TensTwo EQU 0x22
UnitsTwo EQU 0x23
FLAGS EQU 0X24
TimerCounter EQU 0x25 
counter EQU 0X26
outerCounter EQU 0x27 
innerCounter EQU 0x28
;====================================================================
; RESET and INTERRUPT VECTORS
;====================================================================

      ; Reset Vector
RST   code  0x0 
      goto  Start
     
ISR   code 0x04
      NOP 

      BANKSEL PIR1
      BTFSC PIR1, 0 
      GOTO TimerInterrupt 
   
      BANKSEL PORTD
      BSF PORTD, 0
     MOVF FLAGS, W     
     XORLW 0x00       
     BTFSS STATUS, Z  
     GOTO Test1
     INCF TensOne,F 
     MOVF TensOne, W
     CALL  printNumberOne
     MOVF TensOne,W
     XORLW 0x0A ;; CHECK IF EQUAL TO 10 -> CHANGE TO 0 
     BTFSS STATUS, Z
     GOTO ifDone
     CLRF TensOne
     MOVF TensOne, W
     CALL  printNumberOne
     GOTO ifDone
    
    ; Check if REG == 1
Test1     
     MOVF FLAGS, W 
     XORLW 0x01       
     BTFSS STATUS, Z  
     GOTO Test2
     INCF UnitsOne,F 
     CALL  printNumberOne
     MOVF UnitsOne, W
     XORLW 0x0A ;; CHECK IF EQUAL TO 10 -> CHANGE TO 0 
     BTFSS STATUS, Z
     GOTO ifDone
     CLRF UnitsOne
     CALL  printNumberOne
     GOTO ifDone
    
    ; Check if REG == 2
Test2
    MOVF FLAGS, W  
     XORLW 0x02
     BTFSS STATUS, Z 
     GOTO Test3
     INCF TensTwo,F 
     CALL printNumberTwo
     MOVF TensTwo, W
     XORLW 0x0A ;; CHECK IF EQUAL TO 10 -> CHANGE TO 0 
     BTFSS STATUS, Z
     GOTO ifDone
     CLRF TensTwo
      CALL printNumberTwo
     GOTO ifDone
    
    ; Check if REG == 3
Test3
     MOVF FLAGS, W 
     XORLW 0x03       
     BTFSS STATUS, Z  
     GOTO ifDone
     INCF UnitsTwo,F    
     MOVF UnitsTwo, W 
     CALL printNumberTwo
     MOVF TensTwo, W
     XORLW 0x0A ;; CHECK IF EQUAL TO 10 -> CHANGE TO 0 
     BTFSS STATUS, Z
     GOTO ifDone
     CLRF UnitsTwo
     CALL printNumberTwo
     MOVF UnitsTwo, W
     
ifDone
      CLRF TimerCounter
      BCF INTCON, 1 ; Clear the flag interrupt bit
      GOTO endInt
      
TimerInterrupt 
      BANKSEL PIR1
      BCF PIR1, 0 

      INCF TimerCounter, F ; inc and get 
      MOVF TimerCounter, W
      
     
      XORLW 0x05   
      BTFSS STATUS, Z  
      GOTO endInt
      NOP
      BANKSEL PORTD
      INCF FLAGS, F
      MOVF FLAGS, W 
      
      ;INCF PORTD, F
      BSF PORTD,0
     
      CLRF TimerCounter

      
         
endInt
      NOP
      BANKSEL TMR1H
      CLRF TMR1H 
      CLRF TMR1L
      BANKSEL PORTB
      movf PORTB, F	; Read PortB (to itself) to end mismatch condition
      RETFIE     
   

INCLUDE "LCDIS_PORTD.INC" 
;====================================================================
; CODE SEGMENT
;====================================================================

PGM   code
Start
      NOP
      ;; Initializations Here!
      BANKSEL TRISD 
      CLRF TRISD 
      
      BANKSEL TRISC 
      CLRF TRISC 
      
      BANKSEL TRISB 
      BSF TRISB, 0
      
      ; Enable Interrupts!
      BSF INTCON, GIE 
      BSF INTCON, PEIE 
     

      
      
      BANKSEL T1CON
      BSF T1CON, T1CKPS1
      BSF T1CON, T1CKPS0  ; 1:8 prescaler -> 0.5 sec
      
      
      BANKSEL PIE1
      BSF PIE1, TMR1IE 
      
      BANKSEL PORTD
      MOVLW 0x00
      MOVWF PORTD
      CLRF TensOne
      CLRF UnitsOne
      
      
      CALL xms
      CALL xms
      CALL inid
    
      ; Code Here!
      CALL printMessage
      CALL printMessage
      CALL printMessage
      
      CALL print1 ;; 2nd line 00 -> INTERRUPT & Change 
      
      CALL printNumberOne
      
      
      

      BSF INTCON, INTE
      

      BANKSEL T1CON
      BSF T1CON, TMR1ON ; Get Timer Started!
      
      BANKSEL PORTD
      
Loop 
      BTFSC FLAGS, 1 ; Bit 1 is set = FLAGS = 2/3 -> Break Out  b'0000_0010
      GOTO Number2
      GOTO Loop
      
      
Number2      
      CALL printNumberOne
      NOP 
      BANKSEL T1CON
      BCF T1CON, TMR1ON ;; Disable timer & do LCD Work
      
      ;;;;;;;;;;;;;;;;;;;;;;;;
      ;; LCD Work.
      CALL SECONDNUM
      CALL printNumberTwo

      ; PUT 00
      ;;;;;;;;;;;;;;;;;;;;;;;;
        
      ;; After finishing LCD Work, Re-enable Timer & Reset it and go again
      NOP
      BANKSEL T1CON
      BSF T1CON, TMR1ON
      BANKSEL TMR1H
      CLRF TMR1H 
      CLRF TMR1L
     
      BANKSEL PORTD
Loop2  
      BTFSC FLAGS, 2 ; Bit 3 is set = FLAGS = 4 or higher -> Break Out  
      GOTO Communication
      GOTO Loop2

Communication
      NOP 
      BANKSEL T1CON
      BCF T1CON, TMR1ON
      
      ; PRINT =
      BANKSEL PORTD
      BCF Select, RS
      MOVLW	0xC0	; DDRAM address for the second line
      CALL	send		; and send command
      
       ; Set the cursor to the second line, 5 position

      BCF Select, RS        ; Command mode
      MOVLW   0x14   
      CALL    send         
      MOVLW   0x14   
      CALL    send  
      MOVLW   0x14   
      CALL    send 
      MOVLW   0x14   
      CALL    send 
      MOVLW   0x14   
      CALL    send 
      
      
      BSF	Select,RS	; Select data mode
      MOVLW '='
      CALL send
      
      ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
      ;;; START Sending DATA to co-processor ;;;;;;;;;;;;;;;;;;;;;;;;;;;
      ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
      ;;;; Multiply TensOne by 10 & Add UnitsOne to it , that will be our first number;;;;;;;
      ;;;; We will send it and make sure that our MSB is set to 1 (0-99 Number can be reperesnted in 7 Bits thus the MSB is free-use)
      ;;;; We will give a small delay for the co-proccessor to read the value then we will send the UnitsTwo Number Through (MSB = 1 Aswell)
      ;;;; Then Do a quick multiplication & then switch PORTC to OUTPUTS VIA TRISC & LISTEN UNTIL THE BUS CHANGES. 
      ;;;; Add Both Results then Send to LCD.	
      ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
      ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; 00-99 -> 7 bits --- PORTC 8 bits -> PC7 will be used for Synchronization
      
      CLRW 
      ADDWF TensOne, W
      ADDWF TensOne, W
      ADDWF TensOne, W
      ADDWF TensOne, W
      ADDWF TensOne, W
      
      ADDWF TensOne, W
      ADDWF TensOne, W
      ADDWF TensOne, W
      ADDWF TensOne, W
      ADDWF TensOne, W
      
      ADDWF UnitsOne, W ;; Number One now in W
      
      
      
      MOVWF PORTC 
      BSF PORTC, 7  ;; Set Last Bit to Notify co-processor ab number rcved
      
      NOP
      NOP
      NOP
      NOP
      
      MOVF  UnitsTwo, W ;; send unit of number #2
      MOVWF PORTC 
      BCF PORTC, 7 
      
      NOP
      NOP
      NOP
      NOP
      NOP
      NOP
      NOP 		;;; Wait a bit then switch to input & wait for response
      
      BANKSEL TRISC
      MOVLW 0XFF
      MOVWF TRISC   ;; CHANGE PORT C TO INPUT!
      
      BANKSEL PORTC
LoopRCV  
      BTFSC PORTC, 7 ;; IF BIT 7 IS ON -> NUMBER IS RCVD 
      GOTO RCVD
      goto  LoopRCV      

RCVD
      MOVF PORTC, W 
      BCF PORTD, 7
      GOTO endLoop
      ;; next 2 lines will be skipped for now.
      BANKSEL PORTD
      MOVF UnitsTwo,W
endLoop      
       GOTO endLoop
;====================================================================

printMessage:
   MOVLW 'W'
   BSF Select, RS
   CALL send
   MOVLW 'E'
   CALL send
   MOVLW 'L'
   CALL send
   MOVLW 'C'
   CALL send
   MOVLW 'O'
   call send
   MOVLW 'M'
   call send
   MOVLW 'E'
   call send
   
   
   BCF Select, RS
   MOVLW	0xC0	; DDRAM address for the second line
   CALL	send		; and send command
   
   BSF Select, RS
    MOVLW 'M'
    call send
    MOVLW 'U'
    call send
    MOVLW 'L'
    call send
    MOVLW 'T'
    call send
    MOVLW 'I'
    call send
    MOVLW 'P'
    call send
    MOVLW 'L'
    call send
    MOVLW 'I'
    call send
    MOVLW 'C'
    call send
    MOVLW 'A'
    call send
    MOVLW 'T'
    call send
    MOVLW 'I'
    call send
    MOVLW 'O'
    call send
    MOVLW 'N'
    call send
    
    
    CALL Delay1Sec
  
    
    BCF Select, RS 
    MOVLW	0x01		; Code to clear display
    CALL	send		; and send code
    
    RETURN
    
;=====================================================================\
Delay1Sec:
        MOVLW   D'250'       ; Outer loop counter 250 times
        MOVWF   outerCounter ; Move to outer loop counter register

    OuterLoop:
        MOVLW   D'250'       ; Inner loop counter 250 times
        MOVWF   innerCounter ; Move to inner loop counter register

    InnerLoop:
        DECFSZ  innerCounter, F ; Decrement inner loop counter
        GOTO    InnerLoop       ; Continue inner loop if not zero

        DECFSZ  outerCounter, F ; Decrement outer loop counter
        GOTO    OuterLoop       ; Continue outer loop if not zero

RETURN
;=====================================================================
print1:
   BCF Select, RS
   MOVLW	0x80	; DDRAM address for the first position of the first line
   CALL	send	; and send command

    BSF Select, RS
    MOVLW 'N'
    call send
    
    MOVLW 'U'
    call send
    
    MOVLW 'M'
    call send
    
    MOVLW 'B'
    call send
    
   
    MOVLW 'E'
    call send
    
      
    MOVLW 'R'
    call send
    
      
    MOVLW '1'
    call send


RETURN   

;=====================================================================
printNumberOne
	 ;; go to start of line 2
	 BANKSEL PORTD
	BCF Select, RS
	MOVLW	0xC0
	CALL	send
	
	MOVF	TensOne,W		; load high digit result	
	ADDLW	030		; convert to ASCII
	BSF	Select,RS	; Select data mode
	CALL	send		; and send Msd

	MOVF	UnitsOne,W		; load low digit result
	ADDLW	030		; convert to ASCII
	BSF	Select,RS	; Select data mode
	CALL	send		; and send Msd
	
	BCF Select, RS
	 MOVLW	0x80	; DDRAM address for the first position of the first line
	 CALL	send	; and send command

RETURN
;=====================================================================
 SECONDNUM
    BANKSEL PORTD
    BCF Select, RS
    MOVLW	0x80	; DDRAM address for the first position of the first line
    CALL	send	; and send command
   
    BSF Select, RS
    MOVLW 'N'
    call send
    
    MOVLW 'U'
    call send
    
    MOVLW 'M'
    call send
    
    MOVLW 'B'
    call send
    
   
    MOVLW 'E'
    call send
    
      
    MOVLW 'R'
    call send
    
      
    MOVLW '2'
    call send
    
    NOP
    NOP
    
RETURN
;==============================================================================
printNumberTwo

      BANKSEL PORTD
      BCF Select, RS
      MOVLW	0xC0	; DDRAM address for the second line
      CALL	send		; and send command
      
       ;PRINT THE VALUE OF THE SECOND NUMBER
       ; Set the cursor to the second line, fourth position
	 
      BCF Select, RS        ; Command mode
      MOVLW   0x14   
      CALL    send         
      MOVLW   0x14   
      CALL    send  
      BSF Select, RS   
      MOVLW   'X' 
      CALL    send 
      
      
	MOVF	TensTwo,W		; load high digit result	
	ADDLW	030		; convert to ASCII
	BSF	Select,RS	; Select data mode
	CALL	send		; and send Msd

	MOVF	UnitsTwo,W		; load low digit result
	ADDLW	030		; convert to ASCII
	BSF	Select,RS	; Select data mode
	CALL	send		; and send Msd
	
      
      
       BANKSEL PORTD
       BCF Select, RS
       MOVLW	0x80	; DDRAM address for the first position of the first line
       CALL	send	; and send command
   
      
RETURN
;===================================================================
END